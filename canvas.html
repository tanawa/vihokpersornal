<!DOCTYPE html>
<html>
<head>
	<title>ระบบเซ็นออนไลน์</title>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta charset="utf-8">
	<script src="https://www.gstatic.com/firebasejs/7.2.0/firebase-app.js"></script>
	<script src="https://www.gstatic.com/firebasejs/3.1.0/firebase-database.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
	<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
	<link rel="stylesheet" type="text/css" href="style.css">
	<style type="text/css">
		canvas{
			border:1px solid #ddd;
		}
	</style>
</head>
<body onresize="resize()">
	<div id="nav">
		<a href="index.html">ฝ่ายบุคคล<a href="money.html">ฝ่ายการเงิน</a><a href="radio.html">ฝ่ายเทคนิค</a><a href="canvas.html">ระบบเซ็น</a><a href="card.html">ระบบทำบัตร</a>
	</div>
	<center><br>
		<select id="change">
		</select>
	<input type="text" name="" placeholder="เลขยืนยัน" id="number">
	<button onclick="logins()">ตรวจสอบ</button>
	<button onclick="send()">ยืนยัน</button>
	<button onclick="clears()">ล้าง</button>
	<br><br>
<canvas id="canvas"><!--width="1240" height="1754"-->
	
</canvas>
<br>
<a>หมายเหตุ ระบบจะจัดเก็บ IP ที่อยู่ทุกครั้ง</a>
</center>
<script type="text/javascript">
	document.getElementById("canvas").style.width=screen.width;
	function load(item,index){
  		$("#change").append("<option>"+item+"</option>");  	
  }
	var firebaseConfig = {
    apiKey: "AIzaSyAS8FVZdUsHQykpoZEB-uAHRHQYSLPnatg",
    authDomain: "testmes-2fcf4.firebaseapp.com",
    databaseURL: "https://testmes-2fcf4.firebaseio.com",
    projectId: "testmes-2fcf4",
    storageBucket: "testmes-2fcf4.appspot.com",
    messagingSenderId: "866846768783",
    appId: "1:866846768783:web:6ef7269027340cfc"
  };
  firebase.initializeApp(firebaseConfig);
  var ref=firebase.database().ref("send");
  
  ref.once("value",function(snapshot){
  	let list=Object.keys(snapshot.val());
  	console.log(list.length);  
  	list.forEach(load);
  },function(error){

  });
    var drawing=[];
    var name="";
	var login=false;
	var Nx=190,Ny=190;
	if(screen.width>600){
			Ny=190;
			Nx=60;
		}else{
			Ny=340;
			Nx=560;
		}
	var predictX=0,predictY=0;
	var width=3,height=3;
	var changeX=0,changeY=0,positionX=0,positionY=0;
	var canvas=document.getElementById("canvas");
	var ctx=canvas.getContext("2d");
	ctx.beginPath();
	ctx.fillStyle="#3B76D6";
	var lastX=0,lastY=0;
	function resize(){
		console.log(screen.width);
		if(screen.width>600){
			Ny=190;
			Nx=60;
		}else{
			Ny=340;
			Nx=560;
		}
	}
	function clears(){
		if(run && login){
		console.log("dsa");
		drawing=[];
		ctx.clearRect(0,0,canvas.width,canvas.height);
		swal("แจ้งเตือน","ล้างข้อมูลสำเร็จ","success");
		}else{
			swal("แจ้งเตือน","กรุณาล็อกอิน","warning");
		 /**/
		}
	}
	function send(){
		if(run && login){
		if(drawing.length!=0 && name!=""){
			ref=firebase.database().ref("responsesend/"+$("#change").val());
			ref.child(name).set(drawing);
			swal("แจ้งเตือน","ส่งข้อมูลสำเร็จ","success");
		}
		}else{
			swal("แจ้งเตือน","กรุณาล็อกอิน","warning");
		 /**/
		}
	}
	function check(password){
		return password==$("#number").val();
	}
	function logins(){
		if($("#number").val()!=""){
			ref=firebase.database().ref("send/"+$("#change").val());
			ref.once("value",function(snapshot){
				let pass=Object.values(snapshot.val());
				console.log(pass.find(check));
				if(pass.find(check)!=undefined){
					login=true;
					name=$("#number").val();
					swal("แจ้งเตือน","ล็อกอินสำเร็จ","success");
				}else{
					swal("แจ้งเตือน","ล็อกอินไม่สำเร็จ","error");
				}
			},function(error){

			});
		}
		

	}
	function draw(x,y){
		changeX=x-lastX;
		changeY=y-lastY;
		//console.log("changeX:"+changeX+" lastX:"+lastX+" x:"+x);
		//console.log("changeY:"+changeY+" lastY:"+lastY+" Y:"+y);
		let max=(Math.abs(changeY)>Math.abs(changeX) ? changeY:changeX);
		let maxs=(changeY<changeX ? changeY:changeX);
		positionX=lastX;
		positionY=lastY;
		ctx.fillRect(x,y,width,height);
		drawing.push([x,y]);
		for(let u=0;u<Math.abs(max);u++){
				if(positionX<x){
					positionX=positionX+1;
				}else if(positionX>x){
					positionX=positionX-1;
				}
				if(positionY<y){
					positionY=positionY+1;
				}else if(positionY>y){
					positionY=positionY-1;
				}
				ctx.fillRect(positionX,positionY,width,height);
				drawing.push([positionX,positionY]);
			}
		
		
		lastX=x;
		lastY=y;
	}
	var run=true;
	canvas.addEventListener("mousedown",function(e){

		if(run && login){
			run=false;
			width=0;
			height=0;
			lastX=e.offsetX;
			lastY=e.offsetY;
			draw(e.offsetX,e.offsetY);
		}else{
			swal("แจ้งเตือน","กรุณาล็อกอิน","warning");
		 /**/
		}
	    });
	canvas.addEventListener("mouseup",function(e){
run=true;
		 console.log(drawing);
	    });
	canvas.addEventListener("mousemove",function(e){
		if(!run && login){
			if(width<3 && height<3){
				width+=0.25;
				height+=0.25;
			}
			draw(e.offsetX,e.offsetY);
		}else{

		}
	});
	
	canvas.addEventListener("touchstart",function(e){

		if(run && login){
			run=false;
			width=0;
			height=0;
			lastX=e.touches[0].screenX-Nx;
			lastY=e.touches[0].screenY-Ny;
			draw(e.offsetX,e.offsetY);
		}else{
			swal("แจ้งเตือน","กรุณาล็อกอิน","warning");
		 /**/
		}
	    });
	canvas.addEventListener("touchend",function(e){
run=true;
		 
	    });
	canvas.addEventListener("touchmove",function(e){
		console.log(e);
		if(!run && login){
			if(width<3 && height<3){
				width+=0.25;
				height+=0.25;
			}
			draw(e.touches[0].screenX-Nx,e.touches[0].screenY-Ny);
		}else{

		}
	});
	
	
</script>
</body>
</html>